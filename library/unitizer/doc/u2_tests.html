<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />

<meta name="viewport" content="width=device-width, initial-scale=1" />

<meta name="author" content="Brodie Gaslam" />


<title>unitizeR - Test Details</title>

<style type="text/css">
a.anchor-section {margin-left: 10px; visibility: hidden; color: inherit;}
a.anchor-section::before {content: '#';}
.hasAnchor:hover a.anchor-section {visibility: visible;}
</style>
<script>// Anchor sections v1.0 written by Atsushi Yasumoto on Oct 3rd, 2020.
document.addEventListener('DOMContentLoaded', function() {
  // Do nothing if AnchorJS is used
  if (typeof window.anchors === 'object' && anchors.hasOwnProperty('hasAnchorJSLink')) {
    return;
  }

  const h = document.querySelectorAll('h1, h2, h3, h4, h5, h6');

  // Do nothing if sections are already anchored
  if (Array.from(h).some(x => x.classList.contains('hasAnchor'))) {
    return null;
  }

  // Use section id when pandoc runs with --section-divs
  const section_id = function(x) {
    return ((x.classList.contains('section') || (x.tagName === 'SECTION'))
            ? x.id : '');
  };

  // Add anchors
  h.forEach(function(x) {
    const id = x.id || section_id(x.parentElement);
    if (id === '') {
      return null;
    }
    let anchor = document.createElement('a');
    anchor.href = '#' + id;
    anchor.classList = ['anchor-section'];
    x.classList.add('hasAnchor');
    x.appendChild(anchor);
  });
});
</script>

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>





<style type="text/css">
body {
background-color: #fff;
margin: 1em auto;
max-width: 700px;
overflow: visible;
padding-left: 2em;
padding-right: 2em;
font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
font-size: 14px;
line-height: 1.5;
}
#header {
text-align: center;
}
#TOC {
clear: both;

padding: 4px;
width: 100%;
border: 1px solid #CCCCCC;
border-radius: 5px;
background-color: #f6f6f6;
font-size: 13px;
line-height: 1.3;
}
#TOC .toctitle {
font-weight: bold;
font-size: 15px;
margin-left: 5px;
}
#TOC ul {
padding-left: 40px;
margin-left: -1.5em;
margin-top: 5px;
margin-bottom: 5px;
}
#TOC ul ul {
margin-left: -2em;
}
#TOC li {
line-height: 16px;
}
table {
margin: 1em auto;
border-width: 1px;
border-color: #DDDDDD;
border-style: outset;
border-collapse: collapse;
}
table th {
border-width: 2px;
padding: 5px;
border-style: inset;
}
table td {
border-width: 1px;
border-style: inset;
line-height: 18px;
padding: 5px 5px;
}
table, table th, table td {
border-left-style: none;
border-right-style: none;
}
table thead, table tr.even {
background-color: #f7f7f7;
}
p {
margin: 1em 0;
}
blockquote {
background-color: #f6f6f6;
padding: 0.25em 0.75em;
}
hr {
border-style: solid;
border: none;
border-top: 1px solid #777;
margin: 28px 0;
}
dl {
margin-left: 0;
}
dl dd {
margin-bottom: 13px;
margin-left: 13px;
}
dl dt {
font-weight: bold;
}
ul {
margin-top: 0;
}
ul li {
list-style: circle outside;
}
ul ul {
margin-bottom: 0;
}
pre, code {
background-color: #eee;
border-radius: 3px;
color: #333;
}
pre {
white-space: pre-wrap; 
border-radius: 3px;
margin: 5px 0px;
padding: 10px;
font-size: 85%;
}
pre:not([class]) {
background-color: #eee;
}
code {
font-family: Consolas, Monaco, 'Courier New', monospace;
}
p > code, li > code, h1 > code, h2 > code, h3 > code,
h4 > code, h5 > code, h6 > code {
padding: 2px 0px;
line-height: 1;
font-weight: bold;
}
div.figure {
text-align: center;
}
img {
background-color: #FFFFFF;
padding: 2px;
border: 1px solid #DDDDDD;
border-radius: 3px;
border: 1px solid #CCCCCC;
margin: 0 5px;
}
h1 {
margin-top: 0;
padding-bottom: 3px;
font-size: 35px;
line-height: 40px;
border-bottom: 1px solid #999;
}
h2 {
border-bottom: 1px solid #999;
padding-top: 5px;
padding-bottom: 2px;
font-size: 145%;
}
h3 {
padding-top: 5px;
font-size: 120%;
}
h4 {

color: #777;
font-size: 105%;
}
h4.author, h4.date {display: none;}
h5, h6 {

font-size: 105%;
}
a {
color: #2255dd;
font-weight: bold;
text-decoration: none;
}
a:hover {
color: #6666ff; }
a:visited {
color: #800080; }
a:visited:hover {
color: #BB00BB; }
a[href^="http:"] {
text-decoration: underline; }
a[href^="https:"] {
text-decoration: underline; }

code > span.kw { color: #555; font-weight: bold; } 
code > span.dt { color: #902000; } 
code > span.dv { color: #40a070; } 
code > span.bn { color: #d14; } 
code > span.fl { color: #d14; } 
code > span.ch { color: #d14; } 
code > span.st { color: #d14; } 
code > span.co { color: #888888; font-style: italic; } 
code > span.ot { color: #007020; } 
code > span.al { color: #ff0000; font-weight: bold; } 
code > span.fu { color: #900; font-weight: bold; } 
code > span.er { color: #a61717; background-color: #e3d2d2; } 
</style>




</head>

<body>




<h1 class="title toc-ignore">unitizeR - Test Details</h1>
<h4 class="author">Brodie Gaslam</h4>


<div id="TOC">
<ul>
<li><a href="#understanding-tests">Understanding Tests</a><ul>
<li><a href="#test-outcomes">Test Outcomes</a></li>
<li><a href="#what-constitutes-a-test">What Constitutes a Test?</a></li>
<li><a href="#unitizer-test-components"><code>unitizer</code> Test Components</a></li>
</ul></li>
<li><a href="#sections">Sections</a><ul>
<li><a href="#untizer_sect"><code>untizer_sect</code></a></li>
<li><a href="#controlling-test-comparison">Controlling Test Comparison</a></li>
</ul></li>
<li><a href="#special-semantics">Special Semantics</a><ul>
<li><a href="#almost-like-source">Almost Like <code>source</code></a></li>
<li><a href="#on.exit"><code>on.exit</code></a></li>
<li><a href="#evaluation-environments">Evaluation Environments</a></li>
<li><a href="#options-and-streams">Options and Streams</a></li>
</ul></li>
<li><a href="#other-details">Other Details</a><ul>
<li><a href="#matching-tests">Matching Tests</a></li>
<li><a href="#commenting-tests">Commenting Tests</a></li>
</ul></li>
</ul>
</div>

<div id="understanding-tests" class="section level2">
<h2>Understanding Tests</h2>
<div id="test-outcomes" class="section level3">
<h3>Test Outcomes</h3>
<p>When <code>unitize</code> is run with a test file against an existing <code>unitizer</code> store, each test in the file is matched and compared to the corresponding test in the store. Here is a comprehensive list of possible outcomes:</p>
<ul>
<li><strong>New</strong>: a test present in the file is not in the store and needs to be reviewed to confirm it is correct.</li>
<li><strong>Passed</strong>: the test matched the reference test in the store and need not be reviewed.</li>
<li><strong>Failed</strong>: the evaluation of the test from the file differs from the one produced by same expression in the store.</li>
<li><strong>Deleted/Removed</strong>: a test present in the <code>unitizer</code> store no longer exists in the test file so you will be prompted to remove it from the store.</li>
<li><strong>Corrupted/Error</strong>: an error occurred while attempting to compare the file and store tests; this should occur very rarely and is likely the result of using a custom comparison function to compare the tests (see <a href="#controlling-test-comparison"><code>unitizer_sect</code></a> for more details on custom comparison functions). Because the comparison function itself failed, <code>unitizer</code> has no way of knowing whether the test passed or failed; you can think of it as an <code>NA</code> outcome.</li>
</ul>
<p>When reviewing tests, <code>unitizer</code> will group tests by test type, so you will review all new tests in one go, then the failed tests, and so on. As a result, the order that you review tests may not be the same as the order they appear in in the test file.</p>
</div>
<div id="what-constitutes-a-test" class="section level3">
<h3>What Constitutes a Test?</h3>
<p>As noted previously simple assignments are not considered tests. They are stored in the <code>unitizer</code> store, but you are not asked to review them, and their values are not compared to existing reference values prior to storage. The implicit assumption is that if there is an assignment the intent is to use the resulting object in some later test at which point any issues will crop up. Skipping assignment review saves some unnecessary user interaction.</p>
<p>You can force assignments to become tests by wrapping them in parentheses:</p>
<pre><code>a &lt;- my_fun(25)     # this is not a test
(a &lt;- my_fun(42))   # this is a test</code></pre>
<p>The actual rule <code>unitizer</code> uses to decide whether an expression is a test or not is whether it returns invisibly. Wrapping parentheses around an expression that returns invisibly makes it visible, which is why assignments in parentheses become tests. Conversely, you can wrap an expression in <code>invisible(...)</code> to prevent it from being treated as a test.</p>
</div>
<div id="unitizer-test-components" class="section level3">
<h3><code>unitizer</code> Test Components</h3>
<p>The following aspects of a unitizer tests are recorded for future comparison:</p>
<ul>
<li>Value.</li>
<li>Conditions.</li>
<li>Screen (stdout) output.</li>
<li>Message (stderr) output.</li>
<li>Whether the expression issued an “abort” <code>invokeRestart</code> (e.g. was <code>stop</code> called in the expression).</li>
</ul>
<p>Currently only the first two elements are actually compared when determining whether a test passes or fails. These two should capture almost all you would care about from a unit test perspective.</p>
<p>Screen output is omitted from comparison because it can be caused to vary substantially by factors unrelated to source code changes (e.g. console display width). Screen output will also seem identical to the value as most of the time screen output is just the result of printing the return value of an expression. This will not be the case if the expression itself prints to <code>stdout</code> explicitly, or if the function returns invisibly.</p>
<p>Message output is omitted because all typical mechanisms for producing <code>stderr</code> output also produce conditions with messages embedded, so it is usually superfluous to compare them. One exception would be if an expression <code>cat</code>ed to <code>stderr</code> directly.</p>
<p>The “abort” <code>invokeRestart</code> is omitted because it generally is implied by the presence of an error condition and actively monitoring it clutters the diagnostic messaging produced by <code>unitizer</code>. It exists because it is possible to signal a “stop” condition without actually triggering the “abort” restart so in some cases it could come in handy.</p>
<p>While we omit the last three components from comparison, this is just default behavior. You can change this by using the <code>compare</code> argument for <a href="#controlling-test-comparison"><code>unitizer_sect</code></a>.</p>
</div>
</div>
<div id="sections" class="section level2">
<h2>Sections</h2>
<div id="untizer_sect" class="section level3">
<h3><code>untizer_sect</code></h3>
<p>Often it is useful to group tests in sections for the sake of documentation and clarity. Here is a slghtly modified version of the original demo file with sections:</p>
<pre><code>unitizer_sect(&quot;Basic Tests&quot;, {
  library(unitizer.fastlm)
  x &lt;- 1:10
  y &lt;- x ^ 3
  res &lt;- fastlm(x, y)

  get_slope(res)
})

unitizer_sect(&quot;Advanced Tests&quot;, {
  2 * get_slope(res) + get_intercept(res)
  get_rsq(res)
})</code></pre>
<p>Now re-running <code>unitizer</code> segments everything by section (note, first few lines are set-up):</p>
<pre><code>(.unitizer.fastlm &lt;- copy_fastlm_to_tmpdir())
update_fastlm(.unitizer.fastlm, version=&quot;0.1.2&quot;)
install.packages(.unitizer.fastlm, repos=NULL, type='src', quiet=TRUE)
unitize(file.path(.unitizer.fastlm, &quot;tests&quot;, &quot;unitizer&quot;, &quot;unitizer.fastlm.R&quot;))

+------------------------------------------------------------------------------+
| unitizer for: tests/unitizer/unitizer.fastlm.R                               |
+------------------------------------------------------------------------------+

                    Pass Fail  New
 1.    Basic Tests     -    -    1
 2. Advanced Tests     -    -    2
..................................
                       -    -    3
</code></pre>
<p>If there are tests that require reviewing, each section will be reviewed in turn.</p>
<p>Note that <code>unitizer_sect</code> does not create separate evaluation environments for each section. Any created object will be available to all lexically subsequent tests, regardless of whether they are in the same section or not. Additionally <code>on.exit</code> expressions in <code>unitizer_sect</code> are evaluated immediately, not on exit.</p>
<p>It is possible to have nested sections, though at this point in time <code>unitizer</code> only explicitly reports information at the outermost section level.</p>
</div>
<div id="controlling-test-comparison" class="section level3">
<h3>Controlling Test Comparison</h3>
<p>By default tested components (values and conditions) are compared with <code>all.eq</code>, a wrapper around <code>all.equal</code> that returns FALSE on inequality instead of a character description of the inequality. If you want to override the function used for value comparisons it is as simple as creating a new section for the tests you want to compare differently and use the <code>compare</code> argument:</p>
<pre><code>unitizer_sect(&quot;Accessor Functions&quot;, compare=identical,
  {
    get_slope(res)
    get_rsq(res)
    get_intercept(res)
} )</code></pre>
<p>The values produced by these three tests will be compared using <code>identical</code> instead of <code>all.eq</code>. If you want to modify how other components of the test are compared, then you can pass a <code>unitizerItemTestsFuns</code> object as the value to the <code>compare</code> argument instead of a function:</p>
<pre><code>unitizer_sect(&quot;Accessor Functions&quot;,
  compare=unitizerItemTestsFuns(
    value=identical,
    output=all.equal,
    message=identical
  ),
  {
    get_slope(res)
    get_rsq(res)
    get_intercept(res)
} )</code></pre>
<p>This will cause the value of tests to be compared with <code>identical</code>, the screen output with <code>all.equal</code>, and messages (stderr) with <code>identical</code>.</p>
<p>If you want to change the comparison function for conditions, keep in mind that what you are comparing are <code>conditionList</code> objects so this is not straightforward (see <code>getMethod(&quot;all.equal&quot;, &quot;conditionList&quot;)</code>). In the future we might expose a better interface for custom comparison functions for conditions (see issue #32).</p>
<p>If you need to have different comparison functions within a section, use nested sections. While <code>unitizer</code> will only report the outermost section metrics in top-level summaries, the specified comparison functions will be used for each nested section.</p>
</div>
</div>
<div id="special-semantics" class="section level2">
<h2>Special Semantics</h2>
<div id="almost-like-source" class="section level3">
<h3>Almost Like <code>source</code></h3>
<p>When <code>unitizer</code> runs the test expressions in a test file it does more than just evaluating each in sequence. As a result there are some slight differences in semantics relative to using <code>source</code>. We discuss the most obvious ones here.</p>
</div>
<div id="on.exit" class="section level3">
<h3><code>on.exit</code></h3>
<p>Each top-level statement statement, or top-level statement within a <code>unitizer_sect</code> (e.g. anything considered a test), is evaluated directly with <code>eval</code> in its own environment. This means any <code>on.exit</code> expressions will be executed when the top-level expression that defines them is done executing. For example, it is not possible to set an <code>on.exit(...)</code> for an entire <code>unitizer_sect()</code> block, although it is possible to set it for a single sub-expression:</p>
<pre><code>unitizer_sect('on.exit example', {
  d &lt;- c &lt;- b &lt;- 1
  on.exit(b &lt;- 2)
  b                  # == 2!
  {
    on.exit(d &lt;- c &lt;- 3)
    c                # Still 1
  }
  d                  # == 3
}</code></pre>
</div>
<div id="evaluation-environments" class="section level3">
<h3>Evaluation Environments</h3>
<p>Each test is evaluated in its own environment, which has for enclosure the environment of the prior test. This means that a test has access to all the objects created/used by earlier tests, but not objects created/used by subsequent tests. See the <a href="u4_reproducible-tests.html#workspace-and-evaluation-environments">Reproducible Tests Vignette</a> for more details.</p>
</div>
<div id="options-and-streams" class="section level3">
<h3>Options and Streams</h3>
<p>In order to properly capture output, <code>unitizer</code> will modify streams and options. In particular, it will do the following:</p>
<ul>
<li>Temporarily set <code>options(warn&gt;=1L)</code> during expression evaluation.</li>
<li>Temporarily set <code>options(error=NULL)</code> during expression evaluation.</li>
<li>Use <code>sink()</code> to capture any output to <code>stdout</code>.</li>
<li>Use <code>sink(type=&quot;message&quot;)</code> to capture output to <code>stderr</code>.</li>
</ul>
<p>This should all be transparent to the user, unless the user is also attempting to modify these settings in the test expressions. The problematic interaction are around the <code>options</code> function. If the user sets <code>options(warn=1)</code> with the hopes that setting will persist beyond the execution of the test scripts, that will not happen. If the user sets <code>options(error=recover)</code> or some such in a test expression, and that expression throws an error, you will be thrown into recovery mode with no visibility of <code>stderr</code> or <code>stdout</code>, which will make for pretty challenging debugging. Similarly, <code>unitize</code>ing <code>debug</code>ged functions, or interactive functions, is unlikely to work well.</p>
<p>You should be able to use <code>options(warn=2)</code> and <code>options(error=recover)</code> from the interactive <code>unitizer</code> prompt.</p>
<p>If <code>unitize</code> is run with <code>sdtderr</code> or <code>stdout</code> sunk, then it will subvert the sink during test evaluation and reset it to the same sinks on exit. If a test expression sinks either stream, <code>unitizer</code> will stop capturing output from that point on until the end of the test file. At that point, it will attempt to reset the sinks to what they were when <code>unitizer</code> started. Sometimes this is not actually possible. If such a situation occurs, <code>unitizer</code> will release all sinks to try to avoid a situation where control is returned to the user with output streams still captured.</p>
<p>To reduce the odds of storing massive and mostly useless <code>stdout</code>, <code>unitize</code> limits how much output is stored by default. If you exceed the limit you will be warned. You may modify this setting with <code>options(&quot;unitizer.max.capture.chars&quot;)</code>.</p>
</div>
</div>
<div id="other-details" class="section level2">
<h2>Other Details</h2>
<div id="matching-tests" class="section level3">
<h3>Matching Tests</h3>
<p>Whenever you re-run <code>unitize</code> on a file that has already been <code>unitize</code>d, <code>unitizer</code> matches the expressions in that file to those stored in the corresponding <code>unitizer</code> store. <code>unitizer</code> matches only on the deparsed expression, and does not care at all where in the file the expression occurs. If multiple identical expressions exist in a file they will be matched in the order they show up.</p>
<p>The <code>unitizer_sect</code> in which a test was when it was first <code>unitize</code>d has no bearing whatsoever on matching a new test to a reference test. For example, if a particular test was in “Section A” when it was first <code>unitize</code>d, but in the current version of the test file it is in “Section X”, that test will be matched to the current one in “Section X”.</p>
<p>Some expressions may deparse differently on different systems (e.g. numbers with decimal places, non-ASCII characters) so tests containing them may not match correctly across systems. See the <a href="u1_intro.html#test-expressions-are-stored-deparsed">Introductory Vignette</a> for how to avoid problems with this.</p>
</div>
<div id="commenting-tests" class="section level3">
<h3>Commenting Tests</h3>
<p><code>unitizer</code> parses the comments in the test files and attaches them to the test that they document. Comments are attached to tests if they are on the same line as the test, or in the lines between a test and the previous test. Comments are displayed with the test expression during the interactive review mode. Comment parsing is done on a “best-efforts” basis; it may miss some comments, or even fail to work entirely.</p>
</div>
</div>



<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
